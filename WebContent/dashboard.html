<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <link rel="icon" type="image/png" href="assets/img/favicon.ico">
    <title>EmergencyConnect</title>
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="assets/css/master.css">
    <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/light-bootstrap-dashboard.css" rel="stylesheet">
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300' rel='stylesheet' type='text/css'>
    <link href="assets/css/pe-icon-7-stroke.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery-3.2.0.min.js"></script>
    
    <script>
       function codeAddress() {
           alert('ok');
       }
       
      
    //call database to check
       $(document).ready(function() {
        $("#loginSubmit").click(function() { // When HTML DOM "click" event is invoked on element with ID "somebutton", execute the following function...
              var params = {
    			  username: $('#loginUsername').val(),
    			  password: $('#loginPassword').val(),
    			  inputType: "login"
    			}; 
      		$.post("DatabaseServlet", $.param(params), function(responseText) {   // Execute Ajax GET request on URL of "someservlet" and execute the following function with Ajax response text...
                console.log(responseText);        
      
                if( responseText == "VALID"){
                	    $("#loginButton").hide();
                    $("#loginModal").hide();
                    $("#registerButton").hide();
                    $("#accountButton").html("Welcome, " + params.username);
                    $("#accountButton").show();
               	} else {
                      $('#messageDiv').html("<font color='red'>Username or password incorrect </font>");
                      console.log("false");
                }
              });
        });
       })
    
    	//call database to register user
       	$(document).ready(function() {
       		$("#registerSubmit").click(function() {
       			var params = {
                		username: $('#registerUsername').val(),
					firstName: $('#registerfName').val(),
					lastName: $('#registerlName').val(),
                    password: $('#registerPassword').val(),
				    email: $('#registerEmail').val(),
				    phoneNumber: $('#registerPhoneNumber').val(),
                    inputType: "register"
                }; 
       			$.post("DatabaseServlet", $.param(params), function(responseText) {
       				console.log("calledPOST");
       				if( responseText == 'userRegistered'){
       				 	$("#loginButton").hide();
                    	 	$("#registerModal").hide();
                     	$("#registerButton").hide();
                     	$("#accountButton").html("Welcome, " + params.username);
                     	$("#accountButton").show();
     	           	 } else {
     						$("#messageRegister").html("<font color='red'>This username is already taken. Please choose another username.</font>"); 
     	        			console.log("fail");
     	            }
       			});
       		});
       	})
        function fetchAP() {
        console.log("Fetching news from AP...");
        $.ajax({
          dataType: "json",
          // Grabs JSON from url
          url: "https://newsapi.org/v1/articles?source=associated-press&sortBy=top&apiKey=4a4f44aaabb84ddb9f8523e725b22757",
          success: function(response) {
            // "response" is a JSON with the returned data
            console.log(response);
            output_element = "#APNews";
            $(output_element).html("");
            // "articles" is an array of articles
            articles = response.articles;
            for (var i = 0; i < articles.length; i++) {
              currentArticle = articles[i];
              img = "<img height='120px' src='" + currentArticle.urlToImage + "'>";
              title = JSON.stringify(currentArticle.title);
              url = JSON.stringify(currentArticle.url);
              description = "<p>" + clean_stringify(currentArticle.description) + "</p>";
              $(output_element).append("<div class='card'>"
                                      + "<div class='header'>"
                                        + "<h4 class='title'>" + "<a href=" + url + ">" + title + "<a/></h4>"
                                        + "<p class='category'>Associated Press</p>"
                                      + "</div>"
                                      + "<div class='content'>" + img + description + "</div>"
                                    + "</div>");
            }
          }
        });
      }
    
      function fetchNYT() {
   		console.log("Fetching news...");
   		var url = "https://api.nytimes.com/svc/search/v2/articlesearch.json";
   		url += '?' + $.param({
   		  'api-key': "888fd10628734e11810b44d6df4480f3",
   		  'q': "disaster"
   		});
   		$.ajax({
   		  url: url,
   		  dataType: "json",
   		  method: 'GET',
   		}).done(function(response) {
   		  console.log(response);
   		  output_element = "#NYTNews"
   		  articles = response.response.docs;
   		  for (var i=0; i<articles.length; i++){
   			  currentArticle = articles[i];
   			  var webURL, imgURL;
   			  if(currentArticle.multimedia.length != 0){
   				  webURL = JSON.stringify(currentArticle.web_url);
   				  webURL = webURL.substring(1, webURL.length-1);
   				  imgURL = JSON.stringify(currentArticle.multimedia[0].url);
 				  imgURL = imgURL.slice(1, -1);
   				  title = 
   				  $("#NYTNews").append(
   						  "<div class='card'>" +
   						  	"<div class='header'" +
   						      "<h4 class='title'>" +
   						        "<a href='" +
   						          webURL + "'>" +
   						          JSON.stringify(currentArticle.headline.main) +
   						        "</a>" +
   						      "</h4>" +
   						      "<p class='category'>New York Times</p>" +
   						    "</div>" +
   						    "<div class='content'>" +
   						      "<img height='120px' src='https://www.nytimes.com/" + imgURL + "'>" +
   						      "<p>" +
   						        JSON.stringify(currentArticle.snippet) +
   						      "</p>" +
   						    "</div>" +
   						  "</div>"	         
   						  );
   			  }
   		  }
   		}).fail(function(err) {
   		  throw err;
   		});
      }
    
      function clean_stringify(input_string) {
          return JSON.stringify(input_string).replace("\\", "").replace("\\", "").replace("\\", "").replace("\\", "");
      }

      function fetchLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(getPositon);
        } else {
          // Not supported
        }

      function getPositon(position) {
          lat = position.coords.latitude;
          long = position.coords.longitude;
            $.ajax({
          dataType: "json",
          // Grabs JSON from url
          url: "https://maps.googleapis.com/maps/api/geocode/json?latlng=" + lat + "," + long + "&key=AIzaSyBybJlDH9Ioc3s3Xi8GagmzxL3D19pU8QM",
          success: function(response) {
            // "response" is a JSON with the returned data
            city = response.results[3].formatted_address;
            console.log("from Google Reverse Geocoding API, city: " + city);
          }
        });
      }
    }

    function fetchTweets() {
      // $.ajax({
      //  dataType: "json",
      //  // Grabs JSON from url
      //  url: "https://api.twitter.com/1.1/geo/search.json?lat=" + lat + "&long=" + long,
      //  success: function(response) {
      //    // "response" is a JSON with the returned data
      //    console.log(response);
      //  }
      // });
      $.ajax({
        type: "GET",
        // Grabs JSON from url
        url: "test.php",
        success: function(response) {
          // "response" is a JSON with the returned data
          console.log(response);
        }
      });
    }

    function fetchWeather() {
        var key = "91153d239d63d420";
          $.ajax({
        dataType: "json",
        // Grabs JSON from url
        url: "http://api.wunderground.com/api/" + key + "/forecast/geolookup/conditions/q/" + lat + "," + long + ".json",
        success: function(response) {
          // "response" is a JSON with the returned data
          console.log(response);
          $("#weatherTemperature").html(response.current_observation.temperature_string);

          $("#weatherImage").html("<img style='margin: 20px' src=" + response.current_observation.icon_url + ">");

          $("#weatherCity").html(response.location.city);
        }
      });
    }
    </script>
  </head>
   
  <body>
    <div class="wrapper">
    <div class="sidebar" data-color="red" data-image="assets/img/sidebar-5.jpg">
       <div class="sidebar-wrapper">
          <div class="logo">
             <a href="http://www.usc.edu" class="simple-text">
             EmergencyConnect
             </a>
          </div>
          <ul class="nav">
             <li class="active">
                <a href="dashboard.html">
                   <i class="pe-7s-graph"></i>
                   <p>Dashboard</p>
                </a>
             </li>
             <li class="inactive">
                <a href="about.html">
                   <i class="pe-7s-info"></i>
                   <p>About</p>
                </a>
             </li>
          </ul>
       </div>
    </div>
    <div class="main-panel">
    <nav class="navbar navbar-default navbar-fixed">
       <div class="container-fluid">
          <div class="navbar-header">
             <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navigation-example-2">
             <span class="sr-only">Toggle navigation</span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             </button>
             <a class="navbar-brand" href="#">Dashboard</a>
          </div>
          <div class="collapse navbar-collapse">
             <ul class="nav navbar-nav navbar-right">
                <li class="dropdown" style="display: none">
                   <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                   Account
                   <b class="caret"></b>
                   </a>
                   <ul class="dropdown-menu">
                      <li><a href="#">Action</a></li>
                      <li><a href="#">Another One</a></li>
                      <li class="divider"></li>
                      <li><a href="#">Separated Action</a></li>
                   </ul>
                </li>
                <li>
                   <a id="loginButton">
                   Log In
                   </a>
                </li>
                <li>
                   <a id="registerButton">
                   Register
                   </a>
                </li>
                <li>
                   <a id="accountButton" style="display:none">
                   Account
                   </a>
                </li>
             </ul>
          </div>
       </div>
    </nav>
    <!-- reFRESH this page... TEMP -->
    <button type="button" onclick='fetchAP()'>fetch AP News</button>
    <button type="button" onclick='fetchNYT()'>fetch NYT News</button>
    <button type="button" onclick='closeLogin()'>close log in</button>

    <button type="button" onclick='fetchLocation()'>fetch location</button>
    <button type="button" onclick='fetchTweets()'>fetch twitter</button>  
    <button type="button" onclick='fetchWeather()'>fetch weather</button>
    <div id="jsonContent"></div>
    <div class="content">
       <div class="container-fluid">
          <div class="row">
             <div class="col-md-8">
                <!-- First column -->
                <div class="col-md-6">
                   <div class="row">
                      <div class="col-md-12" id="APNews" style="padding-left: 0">
                      </div>
                      <script type="text/javascript">
   					    fetchAP();
					  </script>
                   </div>
                   <div class="row">
                      <div class="col-md-12" style="padding-left: 0">
                         <div class="card">
                            <div class="header">
                               <h4 class="title">Title</h4>
                               <p class="category">Subtitle</p>
                            </div>
                            <div class="content">
                               <!-- Content Here -->
                            </div>
                         </div>
                      </div>
                   </div>
                </div>
                <!-- Second column -->
                <div class="col-md-6">
                   <div class="row">
                      <div class="col-md-12" id="NYTNews" style="padding-right: 0">
                      </div>
                      <script type="text/javascript">
   					    fetchNYT();
					  </script>
                   </div>
                   <div class="row">
                      <div class="col-md-12" style="padding-right: 0">
                         <div class="card">
                            <div class="header">
                               <h4 class="title" id="weatherCity">City</h4>
                               <p class="category" id="weatherTemperature">Temp</p>
                            </div>
                            <div id="weatherImage">
                               <!-- Content Here -->
                            </div>
                         </div>
                      </div>
                   </div>
                </div>
             </div>
             <!-- Search -->
             <div class="col-md-4" >
                <div class="card">
                   <div class="header">
                      <div class="container-fluid">
                         <div class="row">
                            <div class="col-md-12" style="padding:0">
                               <input type="text" class="form-control" placeholder="Search" value="">
                            </div>
                            <!-- 
                               <div class="col-md-2">
                               <button type="submit" class="btn btn-info btn-fill pull-right">x</button></div>
                               </div>
                               -->
                         </div>
                      </div>
                      <div class="content">
                         <!-- Content Here -->
                         <script> 
                            for (i = 0; i < 4; i++) {
                              document.write("<h1>Oh no</h1>");
                              }
                         </script>
                      </div>
                   </div>
                </div>
             </div>
          </div>
       </div>
    </div>
    <div id="loginModal" class="modal">
       <!-- Modal content -->
       <div class="login-modal">
          <span class="close" id= "loginClose">&times;</span>
          <div id="loginContainer" >
             <form >
                <h2>Log In</h2>
                <br/>
                <table >
                   <tr>
                      <td>
                         <label> Username: </label>
                      </td>
                      <td   style="padding-left:5px;">
                         <input style="width: 190px" type="text" id="loginUsername" name="username"  required> 
                      </td>
                   </tr>
                   <tr>
                      <td>
                         <label> Password: </label>
                      </td>
                      <td  style="padding-left:5px;" >
                         <input style="width: 190px" type="text" id="loginPassword" name="password" required><br/>
                      </td>
                   </tr>
                </table>
                <!-- Button calls show() on click-->
                <button id="loginSubmit" type="button" value="Log In">Login</button>
                <div id="messageDiv" ></div>
             </form>
          </div>
       </div>
    </div>
    <!-- Form -->
    <div id="registerModal" class="modal">
       <div class="register-modal">
          <span class="close" id="registerClose">&times;</span> 
          <div id="registerContainer">
             <form>
                <h2>Register</h2>
                <br/>
                <table >
                   <tr>
                      <td>
                         <label>First Name: </label>
                      </td>
                      <td   style="padding-left:5px;">
                         <input style="width: 190px" type="text" id="registerfName" name="fname" required> 
                      </td>
                   </tr>
                   <tr>
                      <td>
                         <label> Last Name: </label>
                      </td>
                      <td  style="padding-left:5px;" >
                         <input style="width: 190px" type="text" id="registerlName" name="lname" required>
                      </td>
                   </tr>
                   <tr>
                      <td>
                         <label> Username: </label>
                      </td>
                      <td  style="padding-left:5px;" >
                         <input style="width: 190px" type="text" id="registerUsername" name="username" required>
                      </td>
                   </tr>
                   <tr>
                      <td>
                         <label> Password: </label>
                      </td>
                      <td  style="padding-left:5px;" >
                         <input style="width: 190px" type="text" id="registerPassword" name="password" required>
                      </td>
                   </tr>
                   <tr>
                      <td>
                         <label> Email: </label>
                      </td>
                      <td  style="padding-left:5px;" >
                         <input style="width: 190px" type="text" id="registerEmail" name="email" required>
                      </td>
                   </tr>
                   <tr>
                      <td>
                         <label>Phone: </label>
                      </td>
                      <td  style="padding-left:5x;" >
                         <input style="width: 190px" type="text" id="registerPhoneNumber" name="phoneNumber" required>
                      </td>
                   </tr>
                </table>
             </form>
             <!-- Button calls show() on click-->
             <button id="registerSubmit" type="button" >Register</button>
             <div id="messageRegister" ></div>
          </div>
       </div>
    </div>
  </body>
  <!--   Core JS Files   -->
  <script src="assets/js/jquery-1.10.2.js" type="text/javascript"></script>
  <script src="assets/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="assets/js/bootstrap-notify.js"></script>
  <script src="assets/js/light-bootstrap-dashboard.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script>
    // Open and close login form
    $("#loginButton").click(function() {
        $("#loginModal").show();
    })
    $("#loginClose").click(function() {
        $("#loginModal").hide();
    })
    // Open and close register form
    $("#registerButton").click(function() {
        $("#registerModal").show();
    })
    $("#registerClose").click(function() {
        $("#registerModal").hide();
    })
   
  </script>
</html>
  